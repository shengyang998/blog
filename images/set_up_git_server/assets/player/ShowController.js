var kShowControllerState_Stopped="Stopped";var kShowControllerState_Starting="Starting";var kShowControllerState_DownloadingScript="DownloadingScipt";var kShowControllerState_SettingUpScene="SettingUpScene";var kShowControllerState_IdleAtFinalState="IdleAtFinalState";var kShowControllerState_IdleAtInitialState="IdleAtInitialState";var kShowControllerState_WaitingToJump="WaitingToJump";var kShowControllerState_ReadyToJump="ReadyToJump";var kShowControllerState_WaitingToDisplay="WaitingToDisplay";var kShowControllerState_ReadyToDisplay="ReadyToDisplay";var kShowControllerState_WaitingToPlay="WaitingToPlay";var kShowControllerState_ReadyToPlay="ReadyToPlay";var kShowControllerState_Playing="Playing";var kKeyDownEvent="keydown";var kSlideIndexDidChangeEvent="ShowController:SlideIndexDidChangeEvent";var ShowController=Class.create({initialize:function(){this.delegate=extractDelegateFromUrlParameter();this.delegate.showDidLoad();this.showUrl="../";this.displayManager=new DisplayManager;this.scriptManager=new ScriptManager(this.showUrl);this.textureManager=new TextureManager(this.showUrl);this.stageManager=new StageManager(this.textureManager,this.scriptManager);this.touchController=new TouchController;this.animationManager=new AnimationManager;this.orientationController=new OrientationController;this.activeHyperlinks=new Array;this.movieHyperlinks=new Array;this.script=null;this.currentSceneIndex=-1;this.nextSceneIndex=-1;this.currentSlideIndex=-1;this.previousSlideIndex=-1;this.currentSoundTrackIndex=0;this.transformOriginValue="";this.accumulatingDigits=false;this.digitAccumulator=0;this.firstSlide=true;this.lastSlideViewedIndex=-1;this.accountID="";this.guid="";this.locale="EN";this.isNavigationBarVisible=false;this.isFullscreen=false;this.volume=3;this.muted=false;this.soundTrackPlayer=null;this.sceneIndexOfPrebuiltAnimations=-1;this.queuedUserAction=null;document.observe(kScriptDidDownloadEvent,this.handleScriptDidDownloadEvent.bind(this));document.observe(kScriptDidNotDownloadEvent,this.handleScriptDidNotDownloadEvent.bind(this));document.observe(kStageIsReadyEvent,this.handleStageIsReadyEvent.bind(this));document.observe(kStageSizeDidChangeEvent,this.handleStageSizeDidChangeEvent.bind(this));document.observe(kKeyDownEvent,this.handleKeyDownEvent.bind(this));document.observe(kSwipeEvent,this.handleSwipeEvent.bind(this));Event.observe(this.displayManager.body,"click",this.handleClickEvent.bind(this));document.observe(kFullscreenChangeEventName,this.handleFullscreenChangeEvent.bind(this));Event.observe(window,"resize",this.handleWindowResizeEvent.bind(this));this.touchController.registerTapEventCallback(this.handleTapEvent.bind(this));this.changeState(kShowControllerState_Stopped);this.movieCache=null;this.audioCache=null;this.playbackController=new KPFPlaybackController({},this.stageManager.stage);this.navigatorController=new NavigatorController(document.getElementById("slideshowNavigator"));this.slideNumberController=new SlideNumberController(document.getElementById("slideNumberControl"));this.slideNumberDisplay=new SlideNumberDisplay(document.getElementById("slideNumberDisplay"));this.helpPlacard=new HelpPlacardController(document.getElementById("helpPlacard"));this.isRecording=false;this.isRecordingStarted=false;if(isIE&&browserVersion<10){this.animationsupported=false}else{this.animationsupported=true}document.observe("contextmenu",this.handlecontextmenuevent.bind(this));event.observe(this.displaymanager.previousbutton,"click",this.gobacktopreviousslide.bind(this,"tappreviousbutton"));event.observe(this.displaymanager.nextbutton,"click",this.advancetonextbuild.bind(this,"tapnextbutton"))},startshow:function(){this.changestate(kshowcontrollerstate_downloadingscript);this.scriptmanager.downloadscript(this.delegate)},exitshow:function(e){cleartimeout(this.exittimeout);if(e){this.delegate.showexited()}else{this.exittimeout=settimeout(function(){this.delegate.showexited()}.bind(this),750)}},promptusertotryagain:function(e){var t="false;t=confirm(e);return" t},handlescriptdiddownloadevent:function(e){switch(this.state){case="" kshowcontrollerstate_downloadingscript:var="" i="t.showMode;if(i==kShowModeHyperlinksOnly){this.displayManager.setHyperlinksOnlyMode()}this.changeState(kShowControllerState_Starting);var" n;var="" s="parseInt(getUrlParameter("restartingSceneIndex"));var" r="document.URL.split("?");var" a="r[0].split("#");if(a[1]){s=parseInt(a[1])}if(s){n=s}else{var" o="getUrlParameter("currentSlide");var" l;if(o){l="parseInt(o)}else{l=1}n=this.scriptManager.sceneIndexFromSlideIndex(l-1)}if(t.recording){if(t.recording.eventTracks[0].type==="navigation"){this.narrationManager=new" narrationmanager(t.recording);n="this.narrationManager.sceneIndexFromNavigationEvent(this.narrationManager.navigationEvents[0]);this.isRecording=true;this.jumpToScene(n,false);break}}if(n">t.lastSceneIndex){break}if(i===kShowModeAutoplay){this.jumpToScene(n,true)}else{var e=t.events[n];var d=e.automaticPlay==1||e.automaticPlay==true;this.jumpToScene(n,d)}break;default:debugMessage(kDebugShowController_HandleScriptDidDownloadEvent,"- hmmm we seem to have arrived here from an unpredicted state");break}},handleScriptDidNotDownloadEvent:function(e){debugMessage(kDebugShowController_HandleScriptDidNotDownloadEvent);var t=this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);if(t){this.scriptManager.downloadScript()}else{this.displayManager.clearLaunchMode();this.displayManager.hideWaitingIndicator()}},handleStageIsReadyEvent:function(e){if(this.isFullscreen){setTimeout(function(){this.displayManager.stageArea.style.opacity=1}.bind(this),50)}else{setTimeout(function(){this.displayManager.stageArea.style.opacity=1}.bind(this),500)}this.positionSlideNumberControl();this.positionSlideNumberDisplay();this.positionHelpPlacard()},positionSlideNumberControl:function(){var e=(this.displayManager.usableDisplayWidth-this.slideNumberController.width)/2;var t=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberController.height+16);this.slideNumberController.setPosition(e,t)},positionSlideNumberDisplay:function(){var e=(this.displayManager.usableDisplayWidth-this.slideNumberDisplay.width)/2;var t=this.displayManager.stageAreaTop+this.displayManager.stageAreaHeight-(this.slideNumberDisplay.height+16);this.slideNumberDisplay.setPosition(e,t)},positionHelpPlacard:function(){var e=(this.displayManager.usableDisplayWidth-this.helpPlacard.width)/2;var t=(this.displayManager.usableDisplayHeight-this.helpPlacard.height)/2;this.helpPlacard.setPosition(e,t)},handleFullscreenChangeEvent:function(){if(document.webkitIsFullScreen||document.mozFullScreen){this.isFullscreen=true}else{this.isFullscreen=false}setTimeout(function(){this.displayManager.layoutDisplay()}.bind(this),0)},handleWindowResizeEvent:function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.changeWindowSize.bind(this),1e3)},changeWindowSize:function(){if(this.delegate.setViewScale){this.scriptManager.reapplyScaleFactor();this.textureManager.slideCache=null;this.textureManager.slideCache={};var e=this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){if(this.currentSceneIndex<this.script.numscenes-1){e=this.currentsceneindex+1}else{if(this.script.loopslideshow){e=0}}}this.jumptoscene(e,false)}document.fire(kshowsizedidchangeevent,{width:this.script.slidewidth,height:this.script.slideheight})},handlestagesizedidchangeevent:function(e){this.touchcontroller.settrackarea(e.memo.left,e.memo.top,e.memo.width,e.memo.height)},handlekeydownevent:function(e){var t="e.charCode||e.keyCode;if(t===kKeyCode_F11||t===kKeyCode_F12){return}var" i="{altKey:!!e.altKey,ctrlKey:!!e.ctrlKey,shiftKey:!!e.shiftKey,metaKey:!!e.metaKey};if(i.metaKey){if(t===kKeyCode_Period||t===kKeyCode_Dot){this.exitShow(true)}else{if(t!=kKeyCode_Return){return}}}else{if(i.ctrlKey){return}}e.stop();this.onKeyPress(t,i)},handleContextMenuEvent:function(e){e.stop()},handleClickEvent:function(e){if(this.isRecording){return}var" t,i;if(e.pagex||e.pagey){t="e.pageX;i=e.pageY}else{t=e.clientX;i=e.clientY}var" n="{pointX:t,pointY:i};if(isIE){window.focus()}if(e.target.nodeName.toLowerCase()==="video"){return}this.processClickOrTapAtDisplayCoOrds(n)},handleTapEvent:function(e){var" i;if(this.slidenumbercontroller.isshowing){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),0);return}if(this.helpPlacard.isShowing){this.helpPlacard.hide();return}var" 1:this.advancetonextbuild("handleswipeevent");break;case="" 2:this.advancetonextslide("handleswipeevent");break;default:break}}else{if(e.memo.direction="=="right"){switch(e.memo.fingers){case" 1:this.gobacktopreviousslide("handleswipeevent");break;case="" 2:this.gobacktopreviousbuild("handleswipeevent");break;default:break}}}},onmousedown:function(e){if(e.leftclick){this.advancetonextbuild("onmousedown")}else{if(e.rightclick){this.gobacktopreviousbuild("onmousedown")}}},onkeypress:function(e,t){if(e="">=kKeyCode_Numeric_0&&e<=kkeycode_numeric_9){e=kkeycode_0+(e-kkeycode_numeric_0)}e+=t.shiftkey?kkeymodifier_shift:0;e+=t.altkey?kkeymodifier_alt:0;e+=t.ctrlkey?kkeymodifier_ctrl:0;e+=t.metakey?kkeymodifier_meta:0;if(this.isrecording){return}var i="false;switch(e){case" kkeycode_escape:this.exitshow(true);break;case="" kkeycode_slash:case="" kkeycode_slash+kkeymodifier_shift:if(this.helpplacard.isshowing){this.helpplacard.hide()}else{this.helpplacard.show()}break;case="" kkeycode_q:this.exitshow(true);break;case="" kkeycode_s:if(this.slidenumbercontroller.isshowing){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),0)}if(this.slideNumberDisplay.isShowing){this.slideNumberDisplay.hide()}else{this.slideNumberDisplay.setSlideNumber(this.currentSlideIndex+1);this.slideNumberDisplay.show()}break;case" kkeycode_return:if(this.accumulatingdigits){this.accumulatingdigits="false;if(this.script.showMode!=kShowModeHyperlinksOnly){if(this.digitAccumulator">this.script.slideCount){this.digitAccumulator=this.script.slideCount}else{if(this.digitAccumulator<1){this.digitaccumulator=1}}this.slidenumbercontroller.setslidenumber(this.digitaccumulator);this.jumptoslide(this.digitaccumulator)}else{debugmessage(kdebugshowcontroller_onkeypress,"- can't="" do="" it,="" we're="" in="" hyperlinks="" only="" mode")}break}case="" kkeycode_n:case="" kkeycode_space:case="" kkeycode_downarrow:case="" kkeycode_rightarrow:case="" kkeycode_pagedown:case="" kkeycode_rightarrow+kkeymodifier_shift:this.advancetonextbuild("onkeypress");break;case="" kkeycode_downarrow+kkeymodifier_shift:case="" kkeycode_pagedown+kkeymodifier_shift:case="" kkeycode_closebracket:case="" kkeycode_equal+kkeymodifier_shift:case="" kkeycode_equal:case="" kkeycode_plus:this.advancetonextslide("onkeypress");break;case="" kkeycode_leftarrow+kkeymodifier_shift:case="" kkeycode_pageup+kkeymodifier_shift:case="" kkeycode_openbracket:this.gobacktopreviousbuild("onkeypress");break;case="" kkeycode_p:case="" kkeycode_pageup:case="" kkeycode_leftarrow:case="" kkeycode_uparrow:case="" kkeycode_uparrow+kkeymodifier_shift:case="" kkeycode_hyphen:case="" kkeycode_minus:this.gobacktopreviousslide("onkeypress");break;case="" kkeycode_delete:i="true;if(this.accumulatingDigits){if(this.digitAccumulator<10){if(this.slideNumberTimeout){clearTimeout(this.slideNumberTimeout)}this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),0)}else{if(this.slideNumberTimeout){clearTimeout(this.slideNumberTimeout)}this.slideNumberTimeout=setTimeout(this.hideAndResetSlideNumberController.bind(this),7e3);var" n="this.digitAccumulator.toString();this.digitAccumulator=parseInt(n.substring(0,n.length-1));this.slideNumberController.setSlideNumber(this.digitAccumulator)}}break;case" kkeycode_home:if(this.script.showmode!="kShowModeHyperlinksOnly){this.jumpToSlide(1)}else{debugMessage(kDebugShowController_OnKeyPress,"-" mode")}break;case="" kkeycode_end:if(this.script.showmode!="kShowModeHyperlinksOnly){this.jumpToSlide(this.script.slideCount)}else{debugMessage(kDebugShowController_OnKeyPress,"-" mode")}break;default:if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.slidenumbertimeout="setTimeout(this.hideAndResetSlideNumberController.bind(this),7e3);if(e">=kKeyCode_0&&e<=kkeycode_9){if(this.slidenumberdisplay.isshowing){this.slidenumberdisplay.hide()}i=true;if(this.accumulatingdigits===false){this.accumulatingdigits=true;this.digitaccumulator=0}if(this.digitaccumulator.tostring().length<4){this.digitaccumulator*=10;this.digitaccumulator+=e-kkeycode_0;this.slidenumbercontroller.setslidenumber(this.digitaccumulator);if(!this.slidenumbercontroller.isshowing){this.slidenumbercontroller.show()}}}else{i=true}break}if(this.accumulatingdigits&&i===false){}},hideandresetslidenumbercontroller:function(){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.accumulatingdigits=false;this.digitaccumulator=0;this.slidenumbercontroller.hide()},hideslidenumberdisplay:function(){this.slidenumberdisplay.hide()},togglefullscreen:function(){if(isie){return}settimeout(function(){this.displaymanager.stagearea.style.opacity=0}.bind(this),0);this.displaymanager.hidehud(true);if(document.webkitisfullscreen||document.mozfullscreen){this.isfullscreen=false;document.webkitcancelfullscreen&&document.webkitcancelfullscreen()||document.mozcancelfullscreen&&document.mozcancelfullscreen()}else{this.isfullscreen=true;document.body.webkitrequestfullscreen&&document.body.webkitrequestfullscreen()||document.body.mozrequestfullscreen&&document.body.mozrequestfullscreen()}},changestate:function(e){if(e!=this.state){this.leavingstate();this.state=e;this.enteringstate()}},leavingstate:function(){switch(this.state){case kshowcontrollerstate_stopped:break;case="" kshowcontrollerstate_starting:break;case="" kshowcontrollerstate_settingupscene:break;case="" kshowcontrollerstate_idleatfinalstate:break;case="" kshowcontrollerstate_idleatinitialstate:break;case="" kshowcontrollerstate_waitingtojump:break;case="" kshowcontrollerstate_readytojump:break;case="" kshowcontrollerstate_waitingtoplay:this.displaymanager.hidewaitingindicator();break;case="" kshowcontrollerstate_readytoplay:break;case="" kshowcontrollerstate_playing:break}},enteringstate:function(){switch(this.state){case="" kshowcontrollerstate_starting:this.displaymanager.showwaitingindicator();break;case="" kshowcontrollerstate_idleatfinalstate:case="" kshowcontrollerstate_idleatinitialstate:this.updateslidenumber();this.displaymanager.hidewaitingindicator();this.createhyperlinksforcurrentstate("idle");runinnexteventloop(this.doidleprocessing.bind(this));break;case="" kshowcontrollerstate_waitingtoplay:this.displaymanager.showwaitingindicator();break;case="" kshowcontrollerstate_playing:break}},doidleprocessing:function(){this.preloadappropriatescenes();if(this.queueduseraction!="null){this.queuedUserAction();this.queuedUserAction=null}else{var" e="this.stageManager.stage;if(e.childNodes.length!=0){this.updateNavigationButtons()}else{}}},truncatedSlideIndex:function(e){return" this.truncatedindex(e,this.script.lastslideindex,this.script.loopslideshow)},truncatedsceneindex:function(e){return="" this.truncatedindex(e,this.script.lastsceneindex,this.script.loopslideshow)},truncatedindex:function(e,t,i){if(e<0){if(i){e="e+t+1}else{e=-1}}else{if(e">t){if(i){e=e-t-1}else{e=-1}}}return e},preloadAppropriateScenes:function(){var e=this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){e++}var t=this.script.slideIndexFromSceneIndexLookup[e];var i=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-1));var n=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-2));var s=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t-3));var r=this.truncatedSceneIndex(e-1);var a=this.truncatedSceneIndex(e-2);var o=this.truncatedSceneIndex(e-3);var l=this.truncatedSceneIndex(e+1);var d=this.truncatedSceneIndex(e+2);var h=this.truncatedSceneIndex(e+3);var c=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+1));var u=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+2));var S=this.scriptManager.sceneIndexFromSlideIndex(this.truncatedSlideIndex(t+3));var p={};var f=gIpad===true;if(!f&&s!=-1){p[s]=true}if(!f&&n!=-1){p[n]=true}if(!f&&i!=-1){p[i]=true}if(!f&&o!=-1){p[o]=true}if(!f&&a!=-1){p[a]=true}if(!f&&r!=-1){p[r]=true}p[this.currentSceneIndex]=true;p[e]=true;if(l!=-1){p[l]=true}if(!f&&d!=-1){p[d]=true}if(!f&&h!=-1){p[h]=true}if(!f&&c!=-1){p[c]=true}if(!f&&u!=-1){p[u]=true}if(!f&&S!=-1){p[S]=true}this.textureManager.preloadScenes(p)},advanceToNextBuild:function(e){if(!this.script){return false}if(this.script.showMode===kShowModeHyperlinksOnly&&e!="currentSceneDidComplete"){return false}if(this.displayManager.infoPanelIsShowing){return false}var t=false;switch(this.state){case kShowControllerState_IdleAtFinalState:if(this.nextSceneIndex===-1){if(this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();this.exitShow()}else{this.stopSoundTrack();break}}t=true;this.jumpToScene(this.nextSceneIndex,true);break;case kShowControllerState_IdleAtInitialState:if(this.currentSceneIndex>=this.script.numScenes){if(this.script.loopSlideshow){t=true;this.jumpToScene(0,false)}else{if(this.delegate.getKPFJsonStringForShow){this.stopSoundTrack();this.exitShow()}else{this.stopSoundTrack();break}}}else{t=true;this.playCurrentScene()}break;default:debugMessage(kDebugShowController_AdvanceToNextBuild,"nextSceneIndex: "+this.nextSceneIndex+" can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time");if(this.queuedUserAction==null){t=true;this.queuedUserAction=this.advanceToNextBuild.bind(this,e)}break}return t},advanceToNextSlide:function(e){if(!this.script){return false}if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t=t+1;case kShowControllerState_IdleAtInitialState:var i=this.scriptManager.slideIndexFromSceneIndex(t);var n;if(i===this.script.slideCount-1){if(this.script.loopSlideshow){n=0}else{return}}else{n=this.currentSlideIndex+1}var s=this.scriptManager.sceneIndexFromSlideIndex(n);var r=this.script.events[s];var a=r.automaticPlay==1||r.automaticPlay==true;this.jumpToSlide(n+1,a);break;default:debugMessage(kDebugShowController_AdvanceToNextSlide,"can't advance now, not in an idle state (currently in '"+this.state+"' state), queue up action to run in next idle time");if(this.queuedUserAction==null){this.queuedUserAction=this.advanceToNextSlide.bind(this,e)}break}},goBackToPreviousBuild:function(e){if(!this.script){return false}this.resetMediaCache();if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t=t+1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var i;if(t===0){if(this.script.loopSlideshow){i=this.script.events.length-1}else{return}}else{i=t-1}this.jumpToScene(i,false);break;default:debugMessage(kDebugShowController_GoBackToPreviousBuild,"can't go back now, not in an idle state (currently in '"+this.state+"' state)");if(this.queuedUserAction==null){this.queuedUserAction=this.goBackToPreviousBuild.bind(this,e)}break}},goBackToPreviousSlide:function(e){if(!this.script){return false}if(this.script.showMode==kShowModeHyperlinksOnly){return}if(this.displayManager.infoPanelIsShowing){return}var t=this.currentSceneIndex;switch(this.state){case kShowControllerState_IdleAtFinalState:t=t+1;case kShowControllerState_Playing:case kShowControllerState_IdleAtInitialState:var i=this.scriptManager.slideIndexFromSceneIndex(t);var n;if(i===0){if(this.script.loopSlideshow){n=this.script.slideCount-1}else{n=0}}else{if(i===-1&&t>0){n=this.script.slideCount-1}else{n=this.currentSlideIndex-1}}this.jumpToSlide(n+1);break;default:debugMessage(kDebugShowController_GoBackToPreviousSlide,"can't go back now, not in an idle state (currently in '"+this.state+"' state)");if(this.queuedUserAction==null){this.queuedUserAction=this.goBackToPreviousSlide.bind(this,e)}break}},calculatePreviousSceneIndex:function(e){if(e==-1){previousSceneIndex=-1}else{previousSceneIndex=e-1}return previousSceneIndex},jumpToSlide:function(e,t){var i=e-1;var n=this.scriptManager.sceneIndexFromSlideIndex(i);this.resetMediaCache();if(t==null){t=false}this.jumpToScene(n,t)},jumpToScene:function(e,t){this.lastSlideViewedIndex=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);if(e===-1){return}switch(this.state){case kShowControllerState_Starting:var i="position:absolute;background-color:transparent; left:0px; top:0px; width:"+this.displayManager.usableDisplayWidth+"px; height:"+this.displayManager.usableDisplayHeight+"px;";this.starting=true;this.maskElement=document.createElement("div");this.maskElement.setAttribute("style",i);document.body.appendChild(this.maskElement);case kShowControllerState_IdleAtInitialState:case kShowControllerState_IdleAtFinalState:case kShowControllerState_ReadyToJump:break;default:debugMessage(kDebugShowController_JumpToScene,"can't jump now, currently in '"+this.state+"' state which does not supports jumping...");return}if(this.textureManager.isScenePreloaded(e)===false){this.changeState(kShowControllerState_WaitingToJump);var n={sceneIndex:e,automaticPlay:t};this.waitForSceneToLoadTimeout=setTimeout(this.handleSceneDidNotLoad.bind(this,n),kMaxSceneDownloadWaitTime);this.textureManager.loadScene(e,this.handleSceneDidLoad.bind(this,n));return}this.changeState(kShowControllerState_SettingUpScene);runInNextEventLoop(this.jumpToScene_partThree.bind(this,e,t))},handleSceneDidLoad:function(e){clearTimeout(this.waitForSceneToLoadTimeout);this.displayManager.setNextButtonEnabled(this.currentSceneIndex<this.script.pagecount-1);switch(this.state){case kshowcontrollerstate_waitingtojump:this.changestate(kshowcontrollerstate_readytojump);this.jumptoscene_parttwo(e.sceneindex,e.automaticplay);break;default:break}},handlescenedidnotload:function(e){cleartimeout(this.waitforscenetoloadtimeout);this.queueduseraction="null;var" t="this.promptUserToTryAgain(kUnableToReachiWorkTryAgain);if(t){var" i="window.location.href;var" n;var="" s="i.indexOf("&restartingSceneIndex");if(s===-1){n=i}else{n=i.substring(0,s)}var" r="n+"&restartingSceneIndex="+e.sceneIndex;window.location.replace(r)}else{this.changeState(kShowControllerState_IdleAtFinalState)}},jumpToScene_partTwo:function(e,t){this.changeState(kShowControllerState_SettingUpScene);runInNextEventLoop(this.jumpToScene_partThree.bind(this,e,t))},jumpToScene_partThree:function(e,t){var" n="i.events[e];var">0){var r=s[0].type==="transition"?i.autoplayTransitionDelay:i.autoplayBuildDelay;setTimeout(function(){this.playCurrentScene()}.bind(this),r*1e3)}else{this.playCurrentScene()}}else{this.playCurrentScene()}}else{this.changeState(kShowControllerState_IdleAtInitialState);if(this.isRecording&&!this.isRecordingStarted){this.narrationManager.start();this.isRecordingStarted=true}}},displayScene:function(e,t){if(e===-1){return}this.animationManager.deleteAllAnimations();var i=this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);var n=t?t.slideIndex:this.scriptManager.slideIndexFromSceneIndex(e);if(i!==n){this.resetMediaCache()}this.setCurrentSceneIndexTo(e);if(t){this.playbackController.renderEvent(t)}else{var s=this.script.slideIndexFromSceneIndexLookup[e];var r=this.script.slideList[s];var a=new KPFEvent({slideId:r,slideIndex:s,sceneIndex:e,event:this.script.events[e],animationSupported:this.animationSupported});this.playbackController.renderEvent(a)}this.updateNavigationButtons()},setCurrentSceneIndexTo:function(e){this.currentSceneIndex=e;this.assignNextSceneIndex();this.updateSlideNumber();this.updateNavigationButtons()},assignNextSceneIndex:function(){this.nextSceneIndex=this.calculateNextSceneIndex(this.currentSceneIndex)},calculateNextSceneIndex:function(e){var t=this.calculateNextSceneIndex_internal(e);return t},calculateNextSceneIndex_internal:function(e){var t=-1;if(e<this.script.lastsceneindex){t=e+1}else{if(this.script.loopslideshow){t=0}else{t=-1}}return t},updateslidenumber:function(){var="" e="this.currentSceneIndex;if(this.state===kShowControllerState_IdleAtFinalState){e=this.nextSceneIndex}var" t="this.scriptManager.slideIndexFromSceneIndex(e);if(this.firstSlide){runInNextEventLoop(function(){this.startSoundTrack();this.displayManager.clearLaunchMode()}.bind(this));this.firstSlide=false}if(this.currentSlideIndex!=t){this.previousSlideIndex=this.currentSlideIndex;this.currentSlideIndex=t;this.displayManager.updateSlideNumber(this.currentSlideIndex+1,this.script.slideCount);this.delegate.propertyChanged(kPropertyName_currentSlide,this.currentSlideIndex+1);document.fire(kSlideIndexDidChangeEvent,{slideIndex:this.currentSlideIndex})}},updateNavigationButtons:function(){var" i="false;if(this.script.lastSceneIndex===-1){i=false;t=false}else{if(this.script.loopSlideshow){i=true;t=true}else{if(e">0){t=true}if(e===0&&this.script.lastSceneIndex===0){i=true}else{if(this.currentSceneIndex<this.script.lastsceneindex){i=true}else{if(this.currentsceneindex===this.script.lastsceneindex){if(this.state===kshowcontrollerstate_idleatinitialstate){i=true}else{i=false}}else{i=false}}}}}this.displaymanager.setpreviousbuttonenabled(t);this.displaymanager.setnextbuttonenabled(i)},playcurrentscene:function(e){var t="this.state;var" i;var="" n="0;var" s="this.playbackController.eventOverallEndTime();this.changeState(kShowControllerState_Playing);if(this.helpPlacard.isShowing){this.helpPlacard.hide()}if(this.slideNumberDisplay.isShowing){this.slideNumberDisplay.hide()}if(e){i=e.sceneIndexToJump;this.resetMediaCache()}else{i=this.nextSceneIndex;var" r="this.scriptManager.slideIndexFromSceneIndex(this.currentSceneIndex);var" a="this.scriptManager.slideIndexFromSceneIndex(i);if(r!==a){this.resetMediaCache()}if(this.playbackController.kpfEvent.event.automaticPlay==true&&this.playbackController.kpfEvent.event.effects[0].type==="transition"){n=this.playbackController.kpfEvent.event.effects[0].beginTime;s=this.playbackController.kpfEvent.event.effects[0].duration}}if(this.animationSupported){clearTimeout(this.animateTimeout);var" o="this.playbackController.kpfEvent.event.effects;if(o.length===0){this.animateTimeout=setTimeout(function(){setTimeout(this.currentSceneDidComplete.bind(this,i),s*1e3+100)}.bind(this),n*1e3)}else{var" l;if(o[0].type="=="transition"){if(isIE||isEdge){l=this.playbackController.renderEffects()}else{if(o[0].name!="com.apple.iWork.Keynote.BLTBlinds"){l=this.playbackController.renderEffects()}}}this.animateTimeout=setTimeout(function(e){if(e==null){e=this.playbackController.renderEffects()}this.playbackController.animateEffects(e);setTimeout(this.currentSceneDidComplete.bind(this,i),s*1e3+100)}.bind(this,l),n*1e3)}}else{var" d="this.script.events[this.currentSceneIndex].automaticPlay;if(i===-1){this.updateNavigationButtons();if(this.delegate.getKPFJsonStringForShow){if(d){setTimeout(this.exitShow.bind(this),2e3)}else{this.exitShow()}}else{this.changeState(kShowControllerState_IdleAtInitialState)}}else{if(d){setTimeout(function(){this.changeState(kShowControllerState_IdleAtInitialState);this.jumpToScene(i,this.script.events[i].automaticPlay)}.bind(this),2e3)}else{this.changeState(kShowControllerState_IdleAtInitialState);setTimeout(this.jumpToScene.bind(this,i,this.script.events[i].automaticPlay),100)}}}},currentSceneDidComplete:function(e){var" i="t.showMode;if(this.slideNumberDisplay.isShowing){this.slideNumberDisplay.hide()}this.changeState(kShowControllerState_IdleAtFinalState);if(i==kShowModeHyperlinksOnly||e!=-1&&e!=this.nextSceneIndex){var" e="" in="" this.moviecache){delete="" this.moviecache[e].videoelement;delete="" this.moviecache[e]}this.moviecache="null},resetAudioCache:function(){for(var" this.audiocache){this.audiocache[e].pause();this.audiocache[e].src="" ;delete="" this.audiocache[e]}this.audiocache="null},updateWindowHistory:function(e){if(typeof" window.history.replacestate!="undefined" ){var="" audio;this.soundtrackplayer.src="../" +e;this.soundtrackplayer.volume="this.script.soundtrack.volume;this.soundTrackPlayer.observe("ended",this.soundTrackItemDidComplete.bind(this),false);this.soundTrackPlayer.load();this.soundTrackPlayer.play()},soundTrackItemDidComplete:function(){this.currentSoundTrackIndex++;if(this.currentSoundTrackIndex<this.script.soundtrack.tracks.length){this.playNextItemInSoundTrack()}else{if(this.script.soundtrack.mode===kSoundTrackModePlayOnce){this.soundTrackPlayer=null}else{if(this.script.soundtrack.mode===kSoundTrackModeLooping){this.startSoundTrack()}}}},processHyperlink:function(e){var" i;if(t.indexof("?slide=")===0){var n=t.substring(7);var s=-1;if(n===" first"){s="0}else{if(n==="last"){s=this.script.slideCount-1}else{var" kshowcontrollerstate_idleatfinalstate:r="r+1;case" kshowcontrollerstate_idleatinitialstate:var="" if(this.script.loopslideshow){a="0}else{if(this.delegate.getKPFJsonStringForShow){this.exitShow()}}}else{a=o+1}}else{if(n==="previous"){if(o===0){if(this.script.loopSlideshow){a=this.script.slideCount-1}else{a=0}}else{a=o-1}}}break;default:break}s=a}}if(s!=-1){this.jumpToHyperlinkSlide(s,e)}}else{if(t.indexOf("?slideid=")===0){var" l="t.substring(9);var" h="0,c=d.length;h<c;h++){if(d[h]===l){s=h;break}}if(s!=-1){this.jumpToHyperlinkSlide(s,e)}}else{if(t.indexOf("?action=retreat")===0){if(this.lastSlideViewedIndex!=-1){this.jumpToHyperlinkSlide(this.lastSlideViewedIndex,e)}}else{if(t.indexOf("?action=exitpresentation")===0){this.exitShow()}else{if(t.indexOf("http:")===0){window.open(t,"_blank",null)}else{if(t.indexOf("mailto:")===0){window.location=t}}}}}}},jumpToHyperlinkSlide:function(e,t){var" kshowcontrollerstate_idleatfinalstate:if(a<this.script.numscenes-1){a="a+1}else{if(this.script.loopSlideshow){a=0}}case" kpfevent({slideid:l,slideindex:o,sceneindex:a,event:r,animationsupported:this.animationsupported});this.displayscene(a,d);this.playcurrentscene({sceneindextojump:n});break;default:return}}else{var="" c="h.automaticPlay==1||h.automaticPlay==true;this.jumpToSlide(e+1,c)}}else{var" this.moviehyperlinks;this.moviehyperlinks="new" array},clearallhyperlinks:function(){this.stagemanager.clearallhyperlinks();delete="" this.activehyperlinks;this.activehyperlinks="new" array},findhyperlinkatcoords:function(e){var="">0;i--){var n=this.activeHyperlinks[i-1];var s=n.targetRectangle;hyperlinkLeft=Math.floor(s.x);hyperlinkTop=Math.floor(s.y);hyperlinkRight=hyperlinkLeft+Math.floor(s.width);hyperlinkBottom=hyperlinkTop+Math.floor(s.height);if(e.pointX>=hyperlinkLeft&&e.pointX<=hyperlinkright&&e.pointy>=hyperlinkTop&&e.pointY<=hyperlinkbottom){return n}}return="" null},createhyperlinksforcurrentstate:function(e){var="" t="-1;switch(this.state){case" kshowcontrollerstate_idleatinitialstate:t="this.currentSceneIndex;break;case" kshowcontrollerstate_idleatfinalstate:if(this.currentsceneindex<this.script.lastsceneindex){t="this.currentSceneIndex+1}else{if(this.script.showMode==kShowModeHyperlinksOnly){t=this.currentSceneIndex}else{if(this.script.loopSlideshow){t=0}}}break;default:break}if(t!=-1){this.clearAllHyperlinks();this.createHyperlinks(t)}},createHyperlinks:function(e){if(e===-1){return}var" i="t.hyperlinks;if(i==null){return}var" n="i.length;var" s;var="" r="150;var" a="50;var" o="this.displayManager.showWidth;var" l="this.displayManager.showHeight;for(s=0;s<n;s++){var" d="i[s];var" h="d.targetRectangle;var" c="{targetRectangle:h,events:d.events,url:d.url};var" u="h.x;var" s="h.y;var" p="o-(h.x+h.width);var" f="l-(h.y+h.top);if(gMode===kModeMobile){if(h.width<r){var" g="r-h.width;var" m="g/2;var" k="g/2;if(u<m){m=u}else{if(p<k){m=m+(k-p)}}c.targetRectangle.x-=m;c.targetRectangle.width+=g}if(h.height<a){var" y="a-h.height;var" v="y/2;var" w="y/2;if(S<v){v=S}else{if(f<w){v=v+(k-p)}}c.targetRectangle.y-=v;c.targetRectangle.height+=y}}this.stageManager.addHyperlink(c.targetRectangle);this.activeHyperlinks[s]=c}if(this.movieHyperlinks.length">0){for(var b=0;b</=hyperlinkbottom){return></=hyperlinkright&&e.pointy></this.script.lastsceneindex){i=true}else{if(this.currentsceneindex===this.script.lastsceneindex){if(this.state===kshowcontrollerstate_idleatinitialstate){i=true}else{i=false}}else{i=false}}}}}this.displaymanager.setpreviousbuttonenabled(t);this.displaymanager.setnextbuttonenabled(i)},playcurrentscene:function(e){var></this.script.lastsceneindex){t=e+1}else{if(this.script.loopslideshow){t=0}else{t=-1}}return></this.script.pagecount-1);switch(this.state){case></=kkeycode_9){if(this.slidenumberdisplay.isshowing){this.slidenumberdisplay.hide()}i=true;if(this.accumulatingdigits===false){this.accumulatingdigits=true;this.digitaccumulator=0}if(this.digitaccumulator.tostring().length<4){this.digitaccumulator*=10;this.digitaccumulator+=e-kkeycode_0;this.slidenumbercontroller.setslidenumber(this.digitaccumulator);if(!this.slidenumbercontroller.isshowing){this.slidenumbercontroller.show()}}}else{i=true}break}if(this.accumulatingdigits&&i===false){}},hideandresetslidenumbercontroller:function(){if(this.slidenumbertimeout){cleartimeout(this.slidenumbertimeout)}this.accumulatingdigits=false;this.digitaccumulator=0;this.slidenumbercontroller.hide()},hideslidenumberdisplay:function(){this.slidenumberdisplay.hide()},togglefullscreen:function(){if(isie){return}settimeout(function(){this.displaymanager.stagearea.style.opacity=0}.bind(this),0);this.displaymanager.hidehud(true);if(document.webkitisfullscreen||document.mozfullscreen){this.isfullscreen=false;document.webkitcancelfullscreen&&document.webkitcancelfullscreen()||document.mozcancelfullscreen&&document.mozcancelfullscreen()}else{this.isfullscreen=true;document.body.webkitrequestfullscreen&&document.body.webkitrequestfullscreen()||document.body.mozrequestfullscreen&&document.body.mozrequestfullscreen()}},changestate:function(e){if(e!=this.state){this.leavingstate();this.state=e;this.enteringstate()}},leavingstate:function(){switch(this.state){case></1){this.digitaccumulator=1}}this.slidenumbercontroller.setslidenumber(this.digitaccumulator);this.jumptoslide(this.digitaccumulator)}else{debugmessage(kdebugshowcontroller_onkeypress,"-></=kkeycode_numeric_9){e=kkeycode_0+(e-kkeycode_numeric_0)}e+=t.shiftkey?kkeymodifier_shift:0;e+=t.altkey?kkeymodifier_alt:0;e+=t.ctrlkey?kkeymodifier_ctrl:0;e+=t.metakey?kkeymodifier_meta:0;if(this.isrecording){return}var></this.script.numscenes-1){e=this.currentsceneindex+1}else{if(this.script.loopslideshow){e=0}}}this.jumptoscene(e,false)}document.fire(kshowsizedidchangeevent,{width:this.script.slidewidth,height:this.script.slideheight})},handlestagesizedidchangeevent:function(e){this.touchcontroller.settrackarea(e.memo.left,e.memo.top,e.memo.width,e.memo.height)},handlekeydownevent:function(e){var></10){this.animationsupported=false}else{this.animationsupported=true}document.observe("contextmenu",this.handlecontextmenuevent.bind(this));event.observe(this.displaymanager.previousbutton,"click",this.gobacktopreviousslide.bind(this,"tappreviousbutton"));event.observe(this.displaymanager.nextbutton,"click",this.advancetonextbuild.bind(this,"tapnextbutton"))},startshow:function(){this.changestate(kshowcontrollerstate_downloadingscript);this.scriptmanager.downloadscript(this.delegate)},exitshow:function(e){cleartimeout(this.exittimeout);if(e){this.delegate.showexited()}else{this.exittimeout=settimeout(function(){this.delegate.showexited()}.bind(this),750)}},promptusertotryagain:function(e){var>