var kStageSizeDidChangeEvent="DisplayManager:StageSizeDidChangeEvent";var kTimeoutValueForCursor=1e3;var kMobilePortraitModeHorizontalMargin=8;var kMobilePortraitModeTopMargin=47;var kMobilePortraitModeVerticalCenterLine=161;var kMobilePortraitModeMaxStageHeight=228;var kMobilePortraitMaxStageHeight=0;var kMobilePortraitMaxStageWidth=0;var kMobileLandscapeModeVerticalMargin=7;var kMobileLandscapeModeHorizontallMargin=15;var kBottomButtonHeight=50;var kNavigationArrowSize=27;var kNavigationAreaHeight=kNavigationArrowSize;var kHelpAreaHeight=16;var kMobilePortraitModeVerticalCenterLineToNavigationAreaGap=148;var kStageToNavigationAreaGap=31;var kNavigationAreaToHelpAreaGap=52;var kHelpAreaToBottomGap=12;var kMobilePortraitModeNavigationAreaSideMargin=32;var kMobilePortraitModeHelpAreaSideMargin=16;var kMobileLandscapeModeMinSideSpacerWidth=kNavigationArrowSize+10;var kPadPortraitModeHorizontalMargin=8;var kPadPortraitModeMaxStageHeight=540;var kPadPortraitModeVerticalCenterLine=400;var kPadLandscapeModeHorizontallMargin=15;var kPadLandscapeModeVerticalMargin=7;var DisplayManager=Class.create({initialize:function(){document.observe(kShowSizeDidChangeEvent,this.handleShowSizeDidChangeEvent.bind(this));document.observe(kOrientationChangedEvent,this.handleOrientationDidChangeEvent.bind(this));this.body=document.getElementById("body");this.stageArea=document.getElementById("stageArea");this.stage=document.getElementById("stage");this.hyperlinkPlane=document.getElementById("hyperlinkPlane");this.waitingIndicator=document.getElementById("waitingIndicator");this.helpText=document.getElementById("helpText");this.previousButton=document.getElementById("previousButton");this.nextButton=document.getElementById("nextButton");this.slideCounter=document.getElementById("slideCounter");this.waitingIndicatorTimeout=null;this.orientation=kOrientationUnknown;this.showWidth=0;this.showHeight=0;this.stageAreaWidth=0;this.stageAreaHeight=0;this.stageAreaTop=0;this.stageAreaLeft=0;this.usableDisplayWidth=0;this.usableDisplayHeight=0;this.inLaunchMode=true;this.initialAddressBarScrollPerformed=false;this.updateUsableDisplayArea();this.positionWaitingIndicator();this.showWaitingIndicator();this.hyperlinksOnly=false;this.showStatisticsDisplay=gIpad&&getUrlParameter("statistics")==="1";this.hasCacheEverGoneOverPixelLimit=false;this.hhasStageEverGoneOverPixelLimit=false;this.cacheHighWaterMark=0;this.stageHighWaterMark=0;if(gMode===kModeMobile){this.stageArea.style.backgroundColor="black";this.helpText.innerHTML=kTapOrSwipeToAdvance}else{Event.observe(this.body,"mousemove",this.handleMouseMove.bind(this));this.lastMouseX=-1;this.lastMouseY=-1;this.cursorTimeout=null;this.setTimeoutForCursor()}},setHyperlinksOnlyMode:function(){this.hyperlinksOnly=true;this.setPreviousButtonEnabled(false);this.setNextButtonEnabled(false);this.helpText.style.display="none"},handleMouseMove:function(e){e=e||window.event;var t=Math.abs(this.lastMouseX-e.clientX)+Math.abs(this.lastMouseY-e.clientY);if(t>10){if(this.cursorIsShowing===false){this.showCursor()}else{if(!this.navigatorIsShowing){this.setTimeoutForCursor()}}}else{if(!this.navigatorIsShowing){this.setTimeoutForCursor()}}this.lastMouseX=e.clientX;this.lastMouseY=e.clientY},updateSlideNumber:function(e,t){var i="";var s=null;if(gMode!=kModeDesktop){i=kSlideLabel+" "+e+"/"+t;s=this.slideCounter}if(s!=null){s.innerHTML=i}},handleShowSizeDidChangeEvent:function(e){this.showWidth=e.memo.width;this.showHeight=e.memo.height;this.layoutDisplay()},handleOrientationDidChangeEvent:function(e){this.orientation=e.memo.orientation;clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.handleOrientationDidChangeEvent_partTwo.bind(this),300)},handleOrientationDidChangeEvent_partTwo:function(){this.layoutDisplay();if(this.inLaunchMode===false){this.showApplicableControls()}},showCursor:function(){if(this.inLaunchMode){return}this.body.style.cursor="default";this.cursorIsShowing=true;this.setTimeoutForCursor()},hideCursor:function(){this.body.style.cursor="none";this.cursorIsShowing=false},setTimeoutForCursor:function(){if(this.cursorTimeout){clearTimeout(this.cursorTimeout)}this.cursorTimeout=setTimeout(this.handleTimeoutForCursor.bind(this),kTimeoutValueForCursor)},clearTimeoutForCursor:function(){if(this.cursorTimeout){clearTimeout(this.cursorTimeout)}},handleTimeoutForCursor:function(){this.hideCursor()},updateUsableDisplayArea:function(){if(gMode===kModeMobile){var e=gIpad;if(this.orientation===kOrientationLandscape){this.usableDisplayWidth=e?kiPadDeviceHeight:kiPhoneDeviceHeight;this.usableDisplayHeight=(e?kiPadDeviceWidth:kiPhoneDeviceWidth)-kiPhoneStatusBarHeight-kiPhoneLandscapeButtonBarHeight-(e?kiPadAddressBarHeight+kiPadBookmarksBarHeight:0)}else{this.usableDisplayWidth=e?kiPadDeviceWidth:kiPhoneDeviceWidth;this.usableDisplayHeight=(e?kiPadDeviceHeight:kiPhoneDeviceHeight)-kiPhoneStatusBarHeight-kiPhonePortraitButtonBarHeight-(e?kiPadBookmarksBarHeight+10:0)}}else{this.usableDisplayWidth=window.innerWidth;this.usableDisplayHeight=window.innerHeight}},clearLaunchMode:function(){this.inLaunchMode=false;var e=this;runInNextEventLoop(this.showAll.bind(this))},positionWaitingIndicator:function(){var e=110;var t=32;var i;var s;if(gMode===kModeMobile&&this.orientation===kOrientationUnknown){i=1e3;s=1e3}else{if(gMode===kModeMobile&&this.orientation===kOrientationPortrait){i=(this.usableDisplayWidth-e)/2;if(gIpad===false){s=kMobilePortraitModeVerticalCenterLine-e/2}else{s=kPadPortraitModeVerticalCenterLine-e/2}}else{i=(this.usableDisplayWidth-e)/2;s=(this.usableDisplayHeight-e)/2}}setElementPosition(this.waitingIndicator,s,i,e,e)},hideWaitingIndicator:function(){this.waitingIndicator.style.display="none"},showWaitingIndicator:function(){this.waitingIndicator.style.display="block"},convertDisplayCoOrdsToShowCoOrds:function(e){var t={};var i=this.stageAreaLeft+this.stageAreaWidth;var s=this.stageAreaTop+this.stageAreaHeight;if(e.pointX<this.stagearealeft||e.pointx>i||e.pointY<this.stageareatop||e.pointy>s){t.pointX=-1;t.pointY=-1}else{t.pointX=(e.pointX-this.stageAreaLeft)/this.stageAreaWidth*this.showWidth;t.pointY=(e.pointY-this.stageAreaTop)/this.stageAreaHeight*this.showHeight}return t},layoutDisplay:function(){this.updateUsableDisplayArea();var e;var t;if(gMode===kModeDesktop){e=this.usableDisplayWidth;t=this.usableDisplayHeight;if(!gShowController.isFullscreen){if(e>this.showWidth||t>t){e=this.showWidth;t=t}}}else{if(gIpad===false){if(this.orientation===kOrientationPortrait){e=this.usableDisplayWidth-2*kMobilePortraitModeHorizontalMargin;t=kMobilePortraitModeMaxStageHeight}else{e=this.usableDisplayWidth-2*kMobileLandscapeModeHorizontallMargin;t=this.usableDisplayHeight-2*kMobileLandscapeModeVerticalMargin}}else{if(this.orientation===kOrientationPortrait){e=this.usableDisplayWidth-2*kPadPortraitModeHorizontalMargin;t=kPadPortraitModeMaxStageHeight}else{e=this.usableDisplayWidth-2*kPadLandscapeModeHorizontallMargin;t=this.usableDisplayHeight-2*kPadLandscapeModeVerticalMargin}}}var i=scaleSizeWithinSize(this.showWidth,this.showHeight,e,t);this.stageAreaWidth=i.width;this.stageAreaHeight=i.height;this.stageAreaLeft=(this.usableDisplayWidth-this.stageAreaWidth)/2;if(gMode===kModeDesktop){this.stageAreaTop=(t-this.stageAreaHeight)/2}else{if(this.orientation===kOrientationPortrait){if(gIpad===false){this.stageAreaTop=Math.max(10,kMobilePortraitModeVerticalCenterLine-this.stageAreaHeight/2)}else{this.stageAreaTop=Math.max(10,kPadPortraitModeVerticalCenterLine-this.stageAreaHeight/2)}}else{this.stageAreaTop=(this.usableDisplayHeight-this.stageAreaHeight)/2}}setElementPosition(this.stageArea,this.stageAreaTop,this.stageAreaLeft,this.stageAreaWidth,this.stageAreaHeight);var s=-1;var a=-1;var o=-1;var r=-1;var n=null;if(gMode===kModeDesktop){n=false;s=-1;a=-1;o=-1;r=-1}else{n=true;o=0;r=0;if(gIpad){a=kiPadDeviceHeight}else{a=kiPhoneDeviceHeight}s=a}if(o!=-1&&r!=-1&&s!=-1&&a!=-1){var h=document.getElementById("background");h.style.top=o;h.style.left=r;h.style.width=s;h.style.height=a;if(n===true){h.style.visibility="visible"}}var l={x:0,y:0,width:this.usableDisplayWidth,height:this.stageAreaTop};var d={x:0,y:this.stageAreaTop+this.stageAreaHeight,width:this.usableDisplayWidth,height:this.usableDisplayHeight-this.stageAreaTop-this.stageAreaHeight};var u={x:0,y:this.stageAreaTop,width:this.stageAreaLeft,height:this.stageAreaHeight};var g={x:this.stageAreaLeft+this.stageAreaWidth,y:this.stageAreaTop,width:this.usableDisplayWidth-this.stageAreaWidth-u.width,height:this.stageAreaHeight};var c=document.getElementById("statisticsDisplay");if(this.showStatisticsDisplay&&gIpad&&this.orientation===kOrientationPortrait){setElementPosition(c,d.y+70,0,this.usableDisplayWidth,d.height-105);c.style.visibility="visible"}if(gMode!=kModeDesktop){if(this.orientation===kOrientationPortrait){var p=kNavigationArrowSize+2*kMobilePortraitModeNavigationAreaSideMargin;var b=kNavigationArrowSize+2*kStageToNavigationAreaGap;var v=this.usableDisplayWidth-2*p;var M=d.y+7;setElementPosition(this.previousButton,M,0,p,b);setElementPosition(this.slideCounter,M+kStageToNavigationAreaGap,p,v,b);setElementPosition(this.nextButton,M,p+v-5,p,b);setElementPosition(this.helpText,d.y+d.height-kHelpAreaToBottomGap-kHelpAreaHeight,0,this.usableDisplayWidth,kHelpAreaHeight);setElementPosition(this.infoPanelIcon,this.usableDisplayHeight-kInfoPanelButtonHeight,this.usableDisplayWidth-kInfoPanelButtonWidth-5,kInfoPanelButtonWidth,kInfoPanelButtonHeight)}else{var m={x:0,y:0,width:0,height:0};if(u.width>kMobileLandscapeModeMinSideSpacerWidth){setElementRect(this.previousButton,u);setElementRect(this.nextButton,g)}else{setElementRect(this.previousButton,m);setElementRect(this.nextButton,m)}setElementRect(this.slideCounter,m);setElementRect(this.helpText,m);setElementRect(this.infoPanelIcon,m)}}this.positionWaitingIndicator();this.hideAddressBar();document.fire(kStageSizeDidChangeEvent,{left:this.stageAreaLeft,top:this.stageAreaTop,width:this.stageAreaWidth,height:this.stageAreaHeight})},showApplicableControls:function(){if(this.inLaunchMode===true){hideElement(this.previousButton);hideElement(this.nextButton);hideElement(this.slideCounter);hideElement(this.helpText);hideElement(this.infoPanelIcon)}else{if(gMode===kModeDesktop){hideElement(this.previousButton);hideElement(this.nextButton);hideElement(this.slideCounter);hideElement(this.helpText);hideElement(this.infoPanelIcon)}else{if(this.orientation===kOrientationPortrait){showElement(this.previousButton);showElement(this.nextButton);showElement(this.slideCounter);showElement(this.helpText);showElement(this.infoPanelIcon)}else{hideElement(this.slideCounter);hideElement(this.helpText);hideElement(this.infoPanelIcon);if(this.stageAreaLeft>kMobileLandscapeModeMinSideSpacerWidth){showElement(this.previousButton);showElement(this.nextButton)}else{hideElement(this.previousButton);hideElement(this.nextButton)}}}}this.hideAddressBar()},showAll:function(){this.hideWaitingIndicator();setTimeout(this.showAll_partTwo.bind(this))},showAll_partTwo:function(){if(gDevice===kDeviceMobile){window.scrollTo(0,1);setTimeout(this.showAll_partThree.bind(this))}else{this.showAll_partThree()}},showAll_partThree:function(){if(this.inLaunchMode===false){this.showApplicableControls()}showElement(this.stageArea);var e=navigator.userAgent.match(/Windows/);if(e){if(gShowController.delegate.triggerReflow){gShowController.delegate.triggerReflow()}}showElement(this.hyperlinkPlane);if(gMode===kModeMobile){showElement(this.infoPanelIcon)}},setPreviousButtonEnabled:function(e){if(this.hyperlinksOnly){return}if(gMode!=kModeDesktop){if(e){this.previousButton.setAttribute("class","previousButtonEnabled")}else{this.previousButton.setAttribute("class","previousButtonDisabled")}}},setNextButtonEnabled:function(e){if(this.hyperlinksOnly){return}if(gMode!=kModeDesktop){if(e){this.nextButton.setAttribute("class","nextButtonEnabled")}else{this.nextButton.setAttribute("class","nextButtonDisabled")}}},hideAddressBar:function(){if(this.inLaunchMode){return}if(gDevice===kDeviceMobile){var e=this.initialAddressBarScrollPerformed?0:kHideAddressBarDelay;setTimeout("window.scrollTo(0, 1);",e);this.initialAddressBarScrollPerformed=true}},updateStatisticsDisplay:function(){if(this.showStatisticsDisplay===false){return}var e=document.getElementById("statisticsDisplay");var t=gShowController.textureManager.getCacheStatistics();var i=gShowController.scriptManager.degradeStatistics;var s=gShowController.stageManager.debugGetStageStatistics();var a=gShowController.textureManager.numLoadFailures;var o=gShowController.textureManager.numOutstandingLoadRequests;var r=1024*1024;var n=gSafeMaxPixelCount/r;n=Math.floor(n*100)/100;t.numPixels/=r;s.numPixels/=r;t.numPixels=Math.floor(t.numPixels*100)/100;s.numPixels=Math.floor(s.numPixels*100)/100;var h=false;var l=false;if(t.numPixels>n){h=true;this.hasCacheEverGoneOverPixelLimit=true}if(s.numPixels>n){l=true;this.hasStageEverGoneOverPixelLimit=true}if(t.numPixels>this.cacheHighWaterMark){this.cacheHighWaterMark=t.numPixels}if(s.numPixels>this.stageHighWaterMark){this.stageHighWaterMark=s.numPixels}var d="<div style="position: absolute; left: 0px;"><b>Cache Statistics:</b><br>- Scenes: <b>"+t.numScenes+"</b><br>- Textures: <b>"+t.numTextures+"</b><br>- Pixels: <b>"+t.numPixels+" MP</b><br>- Peak Pixels: <b>"+this.cacheHighWaterMark+" MP</b><br>%nbsp<br><b>Limits:</b><br>- Max Pixels: <b>"+n+" MP</b><br></div><div style="position: absolute; left: 175px;"><b>Scene Statistics:</b><br>- Scene Index: <b>"+gShowController.currentSceneIndex+"</b><br>- Textures: <b>"+s.numTextures+"</b><br>- Total Pixels: <b>"+s.numPixels+" MP</b><br>- Peak Pixels: <b>"+this.stageHighWaterMark+" MP</b><br><b>Texture Loader:</b><br>- Num Load Requests: <b>"+(o>0?"<span style="color:yellow;">"+o+"</span>":"0")+"</b><br>- Num Load Failures: <b>"+(a>0?"<span style="color:red;">"+a+"</span>":"0")+"</b><br></div><div style="position: absolute; left: 350px;"><b>Degrade Statistics:</b><br>- Scenes w/Degrades: <b>"+i.numDegradedSlides+"</b><br>- Total Textures Degraded: <b>"+i.numDegradedTextures+"</b><br>- Max Textures/Scene: <b>"+i.maxNumDegradedTexturesPerSlide+"</b><br>- Textures in Current: <b>"+(s.numDegraded>0?"<span style="color:yellow;">"+s.numDegraded+"</span>":"0")+"</b><br></div><div style="position: absolute; left: 550px;"><b>Summary:</b><br>- Cache: <br>- Over Pixel Limit Now: <b>"+(h?"<span style="color:red;">YES</span>":"NO")+"</b><br>- Ever Over Pixel Limit: <b>"+(this.hasCacheEverGoneOverPixelLimit?"<span style="color:red;">YES</span>":"NO")+"</b><br>- Stage: <br>- Over Pixel Limit Now: <b>"+(l?"<span style="color:red;">YES</span>":"NO")+"</b><br>- Ever Over Pixel Limit: <b>"+(this.hasStageEverGoneOverPixelLimit?"<span style="color:red;">YES</span>":"NO")+"</b><br></div>";e.innerHTML=d}});</this.stageareatop||e.pointy></this.stagearealeft||e.pointx>